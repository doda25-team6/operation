# ansible/general.yml
---
- name: General configuration for all Kubernetes nodes
  hosts: all
  become: true

  tasks:
    # TODO: add tasks for other parts
    - name: Placeholder task
      ansible.builtin.debug:
        msg: "General playbook running on {{ inventory_hostname }}"

    - name: Ensure .ssh directory exists for vagrant
      file:
        path: /home/vagrant/.ssh
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0700'

    - name: Debug show key file that will be installed
      ansible.builtin.debug:
        msg: "Installing key from file: {{ item }} â€” content: {{ lookup('file', item) }}"
      with_fileglob:
        - "{{ playbook_dir }}/ssh-keys/*.pub"

    - name: Install team SSH keys for vagrant user
      ansible.posix.authorized_key:
        user: vagrant
        state: present
        key: "{{ lookup('file', item) }}"
      with_fileglob:
        - "{{ playbook_dir }}/ssh-keys/*.pub"

    # Step 5
    - name: Turn off Swap
      ansible.builtin.shell: swapoff -a

    # The regex ensures the line is not a comment, but a six-field swap entry
    # \w+ is used since the second field only has word characters
    - name: Remove swap entry to prevent a re-mount on the next boot
      ansible.builtin.lineinfile:
        path: /etc/fstab
        state: absent
        regexp: '^\s*[^#].+\s*\w+\s*swap\s*.+\s*.+\s.+$'

