# ansible/ctrl.yml
---
- name: Controller-specific configuration
  hosts: ctrl
  become: true

  tasks:
    # Step 13
    - name: Check if Kubernetes admin config exists
      ansible.builtin.stat:
        path: /etc/kubernetes/admin.conf
      register: k8s_admin_conf

    - name: Initialize Kubernetes cluster with kubeadm
      ansible.builtin.command:
        # --ignore-preflight-errors=NumCPU to bypass the CPU requirement check
        cmd: kubeadm init --apiserver-advertise-address=192.168.56.100 --node-name=ctrl --pod-network-cidr=10.244.0.0/16 --ignore-preflight-errors=NumCPU
      register: kubeadm_init_result
      when: not k8s_admin_conf.stat.exists

    # Step 14
    - name: Create .kube directory for vagrant user
      ansible.builtin.file:
        path: /home/vagrant/.kube
        state: directory
        owner: vagrant
        group: vagrant
        mode: '0755'

    - name: Copy admin.conf to vagrant user's .kube directory
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/vagrant/.kube/config
        owner: vagrant
        group: vagrant
        mode: '0600'
        remote_src: true

    - name: Copy admin.conf to host (outside VMs)
      ansible.builtin.fetch:
        src: /etc/kubernetes/admin.conf
        dest: "{{ playbook_dir }}/../admin.conf"
        flat: true
        mode: '0600'
      run_once: true

    # Step 15
    - name: Download Flannel manifest
      ansible.builtin.get_url:
        url: https://github.com/flannel-io/flannel/releases/download/v0.26.7/kube-flannel.yml
        dest: /tmp/kube-flannel.yml
        mode: '0644'

    - name: Modify Flannel DaemonSet to use eth1 interface
      ansible.builtin.replace:
        path: /tmp/kube-flannel.yml
        regexp: '(args:\s*\n\s*- --ip-masq\n\s*- --kube-subnet-mgr)'
        replace: '\1\n        - --iface=eth1'

    - name: Apply Flannel network plugin
      ansible.builtin.command:
        cmd: kubectl apply -f /tmp/kube-flannel.yml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    # Step 16
    - name: Set architecture variable
      set_fact:
        helm_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"

    - name: Download Helm binary
      ansible.builtin.get_url:
        url: https://get.helm.sh/helm-v3.16.4-linux-{{ helm_arch }}.tar.gz
        dest: /tmp/helm-v3.16.4-linux-{{ helm_arch }}.tar.gz
        mode: '0644'

    - name: Extract Helm binary
      ansible.builtin.unarchive:
        src: /tmp/helm-v3.16.4-linux-{{ helm_arch }}.tar.gz
        dest: /tmp
        remote_src: true

    - name: Install Helm binary to system PATH
      ansible.builtin.copy:
        src: /tmp/linux-{{ helm_arch }}/helm
        dest: /usr/local/bin/helm
        mode: '0755'
        owner: root
        group: root
        remote_src: true

    # Step 17
    # Added because the helm-diff plugin gets partially installed in step 16 
    # and needs to be reinstalled
    - name: Remove existing helm-diff plugin directory if corrupted
      ansible.builtin.file:
        path: /home/vagrant/.local/share/helm/plugins/helm-diff
        state: absent

    - name: Install helm-diff plugin
      ansible.builtin.command:
        cmd: helm plugin install https://github.com/databus23/helm-diff --version v3.12.5
      become: false
      become_user: vagrant
      environment:
        HOME: /home/vagrant
        KUBECONFIG: /home/vagrant/.kube/config
      register: helm_diff_result
      failed_when: 
        - helm_diff_result.rc != 0
        - '"plugin already exists" not in helm_diff_result.stderr'



    # Step 20

    - name: Install MetalLB CRDs + components
      ansible.builtin.shell: |
        kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.15.2/config/manifests/metallb-native.yaml --validate=false
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes

    - name: Create MetalLB memberlist secret
      ansible.builtin.shell: |
        kubectl create secret generic memberlist \
          -n metallb-system \
          --from-literal=secretkey="$(openssl rand -base64 128)" \
          --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes

    - name: Remove control-plane taint so MetalLB controller can schedule
      ansible.builtin.shell: |
        kubectl taint nodes ctrl node-role.kubernetes.io/control-plane:NoSchedule- || true
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes

    - name: Restart MetalLB pods to pick up new TLS secret
      ansible.builtin.shell: |
        kubectl delete pods -n metallb-system -l app=metallb --ignore-not-found
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes

    - name: Create MetalLB IP pool
      ansible.builtin.copy:
        dest: /tmp/metallb-pool.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: IPAddressPool
          metadata:
            name: default
            namespace: metallb-system
          spec:
            addresses:
              - 192.168.56.90-192.168.56.99
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes

    - name: Wait for MetalLB controller to be ready
      ansible.builtin.shell: |
        kubectl wait -n metallb-system -l app=metallb,component=controller --for=condition=ready pod --timeout=60s
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes

    - name: Apply MetalLB pool
      ansible.builtin.shell: kubectl apply -f /tmp/metallb-pool.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes

    - name: Create MetalLB L2 Advertisement
      ansible.builtin.copy:
        dest: /tmp/metallb-l2.yaml
        content: |
          apiVersion: metallb.io/v1beta1
          kind: L2Advertisement
          metadata:
              name: l2
              namespace: metallb-system
          spec:
            ipAddressPools:
              - default
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes

    - name: Apply L2 Advertisement
      ansible.builtin.shell: kubectl apply -f /tmp/metallb-l2.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes


    # Step 21

    - name: Add Helm repository https://kubernetes.github.io/ingress-nginx
      ansible.builtin.shell: |
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx && \
        helm repo update
      become: yes

    - name: Freeing release name ingress-nginx if it exists
      ansible.builtin.shell: |
        helm uninstall ingress-nginx || true
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes

    - name: Install ingress-nginx via Helm
      ansible.builtin.shell: |
        helm install ingress-nginx ingress-nginx/ingress-nginx \
        --set controller.service.loadBalancerIP=192.168.56.90
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      become: yes
